<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>San Diego Mexican Food Explorer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f4f4f4;
    }

    #controls {
      margin-bottom: 1rem;
    }

    #results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
    }

    .place {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: background 0.3s ease;
      position: relative;
      z-index: 1;
      overflow: hidden;
      height: 360px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .place:hover {
      background-image:
      linear-gradient(rgba(222, 222, 222, 0.3), rgba(222, 222, 222, 0.3));
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .place img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .jerberto-rating {
      font-weight: bold;
      color: green;
      margin-bottom: 0.3rem;
    }

    #map {
      height: 600px;
      width: 100%;
      display: none;
    }

    #loading {
      display: none;
      font-size: 1.5rem;
      text-align: center;
    }

    #pagination {
      margin-top: 1rem;
      text-align: center;
    }

    .emoji-loader {
      animation: spin 1s linear infinite;
      font-size: 2rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Jerberto's üåÆ San Diego Mexican Food Finder</h1>

  <div id="controls">
    <input type="text" id="filter-name" placeholder="Search by name" oninput="applyFilters()" />
    <select id="filter-rating" onchange="applyFilters()">
      <option value="">All Ratings</option>
      <option value="4">4+</option>
      <option value="4.5">4.5+</option>
    </select>
	<select id="filter-city" onchange="applyFilters()">
	  <option value="">All Regions</option>
	  <option value="north">North</option>
	  <option value="east">East</option>
	  <option value="central">Central</option>
	  <option value="south">South</option>
	  <option value="west">West</option>
	</select>
    <button onclick="toggleView()">Toggle Map View</button>
  </div>

  <div id="map"></div>
  <div id="region-counts" style="margin-bottom: 1rem; font-weight: bold;"></div>
  <div id="results"></div>
  <div id="loading">üåØ<span class="emoji-loader">üåØ</span> Loading...</div>
  <div id="pagination">
    <button onclick="prevPage()">Prev</button>
    <span id="page-info"></span>
    <button onclick="nextPage()">Next</button>
  </div>

  <script>
    let currentResults = [];
    let currentPage = 1;
    let totalPages = 1;
    const perPage = 20;
    let map, mapInitialized = false, markers = [];

    function fetchPage() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('loading').style.display = 'block';

      fetch(`/api/google-places-all?page=${currentPage}&limit=100`)
        .then(res => res.json())
        .then(data => {
          currentResults = data.results || [];
          applyFilters();
        })
        .catch(err => {
          document.getElementById('results').innerHTML = `<p>Error: ${err.message}</p>`;
          document.getElementById('loading').style.display = 'none';
        });
    }

    function applyFilters() {
      const city = document.getElementById('filter-city').value.toLowerCase();
      const minRating = parseFloat(document.getElementById('filter-rating').value) || 0;
      const nameFilter = document.getElementById('filter-name').value.toLowerCase();

      const filtered = currentResults.filter(place => {
        const nameMatch = nameFilter ? place.name?.toLowerCase().includes(nameFilter) : true;
		const cityMatch = city ? place.cityCenter?.toLowerCase() === city : true;
        const ratingMatch = place.rating ? place.rating >= minRating : false;
        return nameMatch && cityMatch && ratingMatch;
      });
      
		// Group and count by cityCenter
		const counts = {};
		currentResults.forEach(place => {
		  const center = place.cityCenter || 'Unknown';
		  counts[center] = (counts[center] || 0) + 1;
		});
		
		let countHtml = 'Restaurant Counts by Region: ';
		for (const [region, count] of Object.entries(counts)) {
		  countHtml += `${region}: ${count} | `;
		}
		
		document.getElementById('region-counts').innerText = countHtml.slice(0, -2);

      renderFilteredResults(filtered);
    }

    function renderFilteredResults(filteredList) {
      const start = (currentPage - 1) * perPage;
      const paginated = filteredList.slice(start, start + perPage);
      totalPages = Math.ceil(filteredList.length / perPage);

      const html = paginated.map(place => {
        const photoUrl = place.photoUrl;
        const jerbertoRating = "‚≠ê " + (Math.random() * 2 + 3).toFixed(1);
        return `
          <div class="place" onclick="openVideo('${place.place_id}')">
            <div class="jerberto-rating">Jerberto's Rating: ${jerbertoRating}</div>
            <strong>${place.name}</strong><br/>
            ${place.vicinity || ''}<br/>
            Google: ‚≠ê ${place.rating || 'N/A'}
            ${photoUrl ? `<img src="${photoUrl}" alt="Photo of ${place.name}" />` : ''}
          </div>
        `;
      }).join('');

      document.getElementById('results').innerHTML = html;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      renderMapMarkers(filteredList);
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        applyFilters();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        applyFilters();
      }
    }

    function openVideo(placeId) {
      alert("Video for place ID: " + placeId + "\n[In future: embed video from DB]");
    }

    function toggleView() {
      const results = document.getElementById('results');
      const mapDiv = document.getElementById('map');
      const isMap = mapDiv.style.display === 'block';

      if (isMap) {
        mapDiv.style.display = 'none';
        results.style.display = 'grid';
      } else {
        results.style.display = 'none';
        mapDiv.style.display = 'block';

		if (!mapInitialized) {
		  map = new google.maps.Map(document.getElementById('map'), {
		    zoom: 10,
		    center: { lat: 32.8626, lng: -117.0022 } // Center of San Diego County
		  });
		  mapInitialized = true;
		}

        renderMapMarkers(currentResults);
      }
    }

    function renderMapMarkers(places) {
      if (!map) return;

      markers.forEach(marker => marker.setMap(null));
      markers = [];

      places.forEach(place => {
        if (!place.geometry || !place.geometry.location) return;

        const position = {
          lat: place.geometry.location.lat,
          lng: place.geometry.location.lng
        };

        const marker = new google.maps.Marker({
          position,
          map,
          title: place.name
        });

        marker.addListener('click', () => openVideo(place.place_id));
        markers.push(marker);
      });

      if (places[0]?.geometry?.location) {
        map.setCenter({
          lat: places[0].geometry.location.lat,
          lng: places[0].geometry.location.lng
        });
      }
    }

    fetchPage();
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_MAPS_API_KEY_HERE">
  </script>
</body>
</html>
